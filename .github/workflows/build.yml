name: Build SmartStarter Jar

on:
  workflow_dispatch:
  push: { branches: ["main"] }

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - uses: gradle/actions/setup-gradle@v4

      # settings.gradle: Loom이 추가하는 repo를 허용하기 위해 PROJECT 우선
      - name: Write settings.gradle
        shell: bash
        run: |
          cat > settings.gradle << 'EOF'
          pluginManagement {
            repositories {
              maven { url 'https://maven.fabricmc.net/' }
              gradlePluginPortal()
            }
          }
          dependencyResolutionManagement {
            // Loom의 내부/로컬 repo 추가 허용
            repositoriesMode.set(RepositoriesMode.PREFER_PROJECT)
            repositories {
              mavenCentral()
              maven { url 'https://maven.fabricmc.net/' }
              maven { name 'Mojang'; url 'https://libraries.minecraft.net/' }
            }
          }
          rootProject.name = 'SmartStarter-1.21.6'
          EOF

      # build.gradle: Yarn/모장 맵핑 제거 → intermediary만 사용
      - name: Write build.gradle
        shell: bash
        run: |
          cat > build.gradle << 'EOF'
          plugins {
              id 'fabric-loom' version '1.10.5'
              id 'maven-publish'
          }

          group = 'net.smartmoving'
          version = '1.0.0'

          dependencies {
              minecraft "com.mojang:minecraft:1.21.6"
              // 가장 안정적인 맵핑 좌표 (저장소 꼬임 방지)
              mappings "net.fabricmc:intermediary:1.21.6"
              modImplementation "net.fabricmc:fabric-loader:0.16.14"
              // Fabric API는 필요해질 때만 추가
          }

          java {
              toolchain { languageVersion = JavaLanguageVersion.of(21) }
              withSourcesJar()
          }

          // 클라/서버 소스 분리
          loom { splitEnvironmentSourceSets() }

          processResources {
              inputs.property "version", project.version
              filesMatching("fabric.mod.json") {
                  expand "version": project.version
              }
          }

          tasks.withType(JavaCompile).configureEach {
              options.encoding = "UTF-8"
              options.release = 21
          }

          jar {
              from("LICENSE") { rename { "LICENSE_\${project.name}" } }
          }
          EOF

      # Gradle Wrapper를 8.14.3으로 고정
      - name: Generate Gradle Wrapper (8.14.3)
        run: gradle wrapper --gradle-version 8.14.3

      # 빌드 + remapJar(배포용) 생성
      - name: Build (remap)
        run: ./gradlew --stacktrace --warning-mode all --refresh-dependencies build remapJar

      - name: List outputs
        run: ls -al build/libs || true

      # remapped JAR 업로드
      - name: Upload Jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: SmartStarter-jar
          path: build/libs/*-remapped.jar
