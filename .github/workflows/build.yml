name: Build SmartStarter Jar

on:
  push: { branches: ["main"] }
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - uses: gradle/actions/setup-gradle@v4

      - name: Write settings.gradle
        shell: bash
        run: |
          cat > settings.gradle << 'EOF'
          pluginManagement {
            repositories {
              maven { url 'https://maven.fabricmc.net/' }
              gradlePluginPortal()
            }
          }
          dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.PREFER_SETTINGS)
            repositories {
              mavenCentral()
              maven { url 'https://maven.fabricmc.net/' }
              maven { name 'Mojang'; url 'https://libraries.minecraft.net/' }
            }
          }
          rootProject.name = 'SmartStarter-1.21.6'
          EOF

      - name: Patch build.gradle
        shell: bash
        run: |
          sed -i "s/id[[:space:]]*['"]fabric-loom['"][[:space:]]*version[[:space:]]*['"]1\.10['"]/id 'fabric-loom' version '1.10.5'/" build.gradle || true
          grep -q "libraries.minecraft.net" build.gradle ||             sed -i "0,/repositories[[:space:]]*{/s//repositories {\n    maven { name 'Mojang'; url 'https:\/\/libraries.minecraft.net\/' }/" build.gradle

      - name: Generate Gradle Wrapper
        run: gradle wrapper

      - name: Build
        run: ./gradlew --refresh-dependencies build

      - name: Upload Jar artifact
        uses: actions/upload-artifact@v4
        with:
          name: SmartStarter-jar
          path: build/libs/*.jar
